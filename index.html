<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gaussian Log → Com</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M12 4 L42 4 L52 14 L52 60 L12 60 Z' fill='white' stroke='%236fcdff' stroke-width='2.5' stroke-linejoin='round'/><path d='M42 4 L42 14 L52 14' fill='none' stroke='%236fcdff' stroke-width='2.5' stroke-linejoin='round'/><line x1='20' y1='24' x2='44' y2='24' stroke='%23dca4ff' stroke-width='2' stroke-linecap='round'/><line x1='20' y1='32' x2='38' y2='32' stroke='%23dca4ff' stroke-width='2' stroke-linecap='round' opacity='0.6'/><text x='32' y='52' text-anchor='middle' font-family='serif' font-weight='700' font-size='18' fill='%23ffcf51'>&#x3a8;</text></svg>">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, 'Helvetica Neue', sans-serif;
    background: linear-gradient(180deg, #e8f4ff 0%, #f3eaff 60%, #fff7e0 100%);
    color: #1a1a2e;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 48px 20px;
  }
  h1 {
    font-size: 1.8em;
    font-weight: 800;
    margin-bottom: 6px;
    background: linear-gradient(135deg, #6fcdff, #dca4ff);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.02em;
  }
  .subtitle {
    font-size: 0.9em;
    color: rgba(26,26,46,0.5);
    margin-bottom: 32px;
    font-weight: 500;
  }
  .card {
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.06), 0 1px 4px rgba(0,0,0,0.04);
    padding: 28px;
    width: 100%;
    max-width: 1000px;
  }
  #input.dragover {
    border-color: #6fcdff;
    background: rgba(111,205,255,0.06);
    box-shadow: 0 0 0 3px rgba(111,205,255,0.2);
  }
  .container { display: flex; gap: 16px; }
  .panel { flex: 1; display: flex; flex-direction: column; }
  .panel label {
    font-size: 0.7em;
    font-weight: 700;
    color: rgba(26,26,46,0.4);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 8px;
  }
  textarea {
    width: 100%;
    height: 360px;
    background: rgba(255,255,255,0.7);
    color: #1a1a2e;
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 14px;
    padding: 16px;
    font-family: 'Menlo', 'SF Mono', 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.5;
    resize: vertical;
    transition: all 0.25s;
  }
  textarea:focus {
    outline: none;
    border-color: #6fcdff;
    box-shadow: 0 0 0 3px rgba(111,205,255,0.15);
    background: #fff;
  }
  textarea[readonly] { background: rgba(245,245,250,0.6); }
  .buttons {
    display: flex;
    gap: 10px;
    margin-top: 22px;
    justify-content: center;
  }
  button {
    padding: 12px 28px;
    border: none;
    border-radius: 50px;
    font-size: 0.9em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  button:active { transform: scale(0.97); }
  #convertBtn {
    background: linear-gradient(135deg, #ffcf51, #ffb830);
    color: #1a1a2e;
    box-shadow: 0 2px 12px rgba(255,207,81,0.35);
  }
  #convertBtn:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(255,207,81,0.45); }
  #copyBtn, #downloadBtn {
    background: rgba(0,0,0,0.04);
    color: rgba(26,26,46,0.6);
    border: 1px solid rgba(0,0,0,0.06);
  }
  #copyBtn:hover, #downloadBtn:hover {
    background: rgba(0,0,0,0.08);
    transform: scale(1.05);
  }
  .msg {
    font-size: 0.8em;
    color: #6fcdff;
    margin-top: 14px;
    text-align: center;
    min-height: 1.2em;
    font-weight: 500;
  }
  @media (max-width: 700px) {
    .container { flex-direction: column; }
    textarea { height: 250px; }
  }
  /* プレビューモーダル */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
    z-index: 100;
    justify-content: center;
    align-items: center;
    padding: 24px;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 16px 48px rgba(0,0,0,0.15);
    width: 100%;
    max-width: 800px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .modal-header {
    padding: 20px 24px 12px;
    font-weight: 700;
    font-size: 1em;
    color: #1a1a2e;
    border-bottom: 1px solid rgba(0,0,0,0.06);
  }
  .modal-header small {
    display: block;
    font-weight: 500;
    font-size: 0.8em;
    color: rgba(26,26,46,0.45);
    margin-top: 4px;
  }
  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 24px;
  }
  .modal-body pre {
    font-family: 'Menlo', 'SF Mono', 'Courier New', monospace;
    font-size: 11px;
    line-height: 1.6;
    white-space: pre;
    color: rgba(26,26,46,0.4);
    margin: 0;
  }
  .modal-body pre .highlight {
    background: rgba(111,205,255,0.18);
    color: #1a1a2e;
    font-weight: 600;
    display: inline;
  }
  .modal-body pre .highlight-header {
    background: rgba(220,164,255,0.2);
    color: #8b5cf6;
    font-weight: 700;
    display: inline;
  }
  .modal-footer {
    padding: 14px 24px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    border-top: 1px solid rgba(0,0,0,0.06);
  }
  .modal-footer button { font-size: 0.85em; padding: 10px 24px; }
</style>
</head>
<body>

<div style="display:flex;align-items:center;gap:12px">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="48" height="48">
    <path d="M12 4 L42 4 L52 14 L52 60 L12 60 Z" fill="white" stroke="#6fcdff" stroke-width="2.5" stroke-linejoin="round"/>
    <path d="M42 4 L42 14 L52 14" fill="none" stroke="#6fcdff" stroke-width="2.5" stroke-linejoin="round"/>
    <line x1="20" y1="24" x2="44" y2="24" stroke="#dca4ff" stroke-width="2" stroke-linecap="round"/>
    <line x1="20" y1="32" x2="38" y2="32" stroke="#dca4ff" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
    <text x="32" y="52" text-anchor="middle" font-family="serif" font-weight="700" font-size="18" fill="#ffcf51">&#x3a8;</text>
  </svg>
  <h1>Gaussian Log to Com</h1>
</div>
<p class="subtitle">.log ファイルから.com対応形式に変換</p>

<div class="card">
  <div class="container">
    <div class="panel">
      <label>Input</label>
      <textarea id="input" placeholder="ペースト or .logファイルをここにドロップ&#10;&#10;対応形式:&#10;  6列 (log):  1  6  0  -1.179  2.621  1.114"></textarea>
    </div>
    <div class="panel">
      <label>Output</label>
      <textarea id="output" readonly placeholder="変換ボタンを押すと結果が表示されます"></textarea>
    </div>
  </div>

  <div class="buttons">
    <button id="convertBtn">変換</button>
    <button id="copyBtn">コピー</button>
    <button id="downloadBtn">ダウンロード</button>
  </div>
  <div class="msg" id="msg"></div>
</div>

<!-- プレビューモーダル -->
<div class="modal-overlay" id="previewOverlay">
  <div class="modal">
    <div class="modal-header" id="previewHeader">
      ファイルプレビュー
      <small>ハイライト部分（最後の Input orientation）を抽出します</small>
    </div>
    <div class="modal-body">
      <pre id="previewContent"></pre>
    </div>
    <div class="modal-footer">
      <button id="previewCancel" style="background:rgba(0,0,0,0.04);color:rgba(26,26,46,0.6);border:1px solid rgba(0,0,0,0.06)">キャンセル</button>
      <button id="previewConfirm" style="background:linear-gradient(135deg,#ffcf51,#ffb830);color:#1a1a2e;box-shadow:0 2px 12px rgba(255,207,81,0.35)">この部分を抽出</button>
    </div>
  </div>
</div>

<script>
const SYMBOLS = {
  1:'H',2:'He',3:'Li',4:'Be',5:'B',6:'C',7:'N',8:'O',9:'F',10:'Ne',
  11:'Na',12:'Mg',13:'Al',14:'Si',15:'P',16:'S',17:'Cl',18:'Ar',19:'K',20:'Ca',
  21:'Sc',22:'Ti',23:'V',24:'Cr',25:'Mn',26:'Fe',27:'Co',28:'Ni',29:'Cu',30:'Zn',
  31:'Ga',32:'Ge',33:'As',34:'Se',35:'Br',36:'Kr',37:'Rb',38:'Sr',39:'Y',40:'Zr',
  41:'Nb',42:'Mo',43:'Tc',44:'Ru',45:'Rh',46:'Pd',47:'Ag',48:'Cd',49:'In',50:'Sn',
  51:'Sb',52:'Te',53:'I',54:'Xe',55:'Cs',56:'Ba',57:'La',72:'Hf',73:'Ta',74:'W',
  75:'Re',76:'Os',77:'Ir',78:'Pt',79:'Au',80:'Hg',81:'Tl',82:'Pb',83:'Bi',86:'Rn'
};

function convert(text) {
  return text.split('\n').map(line => {
    const trimmed = line.trim();
    if (!trimmed) return '';
    const parts = trimmed.split(/\s+/);
    let num, x, y, z;
    if (parts.length === 6) {
      num = parseInt(parts[1], 10);
      [x, y, z] = [parts[3], parts[4], parts[5]];
    } else if (parts.length === 4) {
      num = parseInt(parts[0], 10);
      [x, y, z] = [parts[1], parts[2], parts[3]];
    } else {
      return line;
    }
    if (isNaN(num)) return line;
    const sym = SYMBOLS[num];
    if (!sym) return line;
    return ` ${sym.padEnd(2)}     ${x.padStart(12)}   ${y.padStart(12)}   ${z.padStart(12)}`;
  }).join('\n');
}

function findLastInputOrientation(text) {
  const lines = text.split('\n');
  let lastIdx = -1;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('Input orientation:')) lastIdx = i;
  }
  if (lastIdx === -1) return null;
  // ヘッダー部分: "Input orientation:" から "-----" x2 の後のデータ開始まで
  let dataStart = lastIdx + 5;
  let dataEnd = dataStart;
  for (let i = dataStart; i < lines.length; i++) {
    if (lines[i].trim().startsWith('---')) break;
    dataEnd = i + 1;
  }
  return {
    headerStart: lastIdx,
    dataStart: dataStart,
    dataEnd: dataEnd,
    // データ行のみ（変換用）
    dataText: lines.slice(dataStart, dataEnd).join('\n'),
    // ヘッダー含む全セクション（表示用）
    sectionEnd: dataEnd < lines.length && lines[dataEnd].trim().startsWith('---') ? dataEnd + 1 : dataEnd
  };
}

document.getElementById('convertBtn').addEventListener('click', () => {
  const input = document.getElementById('input').value;
  if (!input.trim()) { showMsg('入力が空です'); return; }
  document.getElementById('output').value = convert(input);
  showMsg('変換しました');
});

document.getElementById('copyBtn').addEventListener('click', () => {
  const output = document.getElementById('output');
  if (!output.value) { showMsg('出力が空です'); return; }
  navigator.clipboard.writeText(output.value).then(() => showMsg('コピーしました'));
});

document.getElementById('downloadBtn').addEventListener('click', () => {
  const output = document.getElementById('output').value;
  if (!output) { showMsg('出力が空です'); return; }
  const blob = new Blob([output], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'converted.com';
  a.click();
  URL.revokeObjectURL(a.href);
  showMsg('ダウンロードしました');
});

const inputArea = document.getElementById('input');

inputArea.addEventListener('dragover', e => { e.preventDefault(); inputArea.classList.add('dragover'); });
inputArea.addEventListener('dragleave', () => inputArea.classList.remove('dragover'));
inputArea.addEventListener('drop', e => {
  e.preventDefault();
  inputArea.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
});

let pendingExtract = null;

function handleFiles(files) {
  if (!files.length) return;
  const reader = new FileReader();
  reader.onload = e => {
    const content = e.target.result;
    const isLog = files[0].name.endsWith('.log');
    if (isLog) {
      const result = findLastInputOrientation(content);
      if (!result) { showMsg('Input orientation が見つかりません'); return; }
      showPreview(content, result, files[0].name);
    } else {
      document.getElementById('input').value = content;
      document.getElementById('output').value = '';
      showMsg(`${files[0].name} を読み込みました — 変換ボタンを押してください`);
    }
  };
  reader.readAsText(files[0]);
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showPreview(content, result, filename) {
  const lines = content.split('\n');
  pendingExtract = result.dataText;

  // ハイライト付きHTML生成
  let html = '';
  for (let i = 0; i < lines.length; i++) {
    const escaped = escapeHtml(lines[i]);
    if (i >= result.headerStart && i < result.dataStart) {
      html += `<span class="highlight-header">${escaped}</span>\n`;
    } else if (i >= result.dataStart && i < result.dataEnd) {
      html += `<span class="highlight">${escaped}</span>\n`;
    } else {
      html += escaped + '\n';
    }
  }

  document.getElementById('previewHeader').innerHTML =
    `${escapeHtml(filename)}<small>ハイライト部分（最後の Input orientation）を抽出します</small>`;
  document.getElementById('previewContent').innerHTML = html;
  document.getElementById('previewOverlay').classList.add('active');

  // ハイライト部分にスクロール
  requestAnimationFrame(() => {
    const firstHL = document.querySelector('.modal-body .highlight-header');
    if (firstHL) firstHL.scrollIntoView({ block: 'center' });
  });
}

document.getElementById('previewConfirm').addEventListener('click', () => {
  if (pendingExtract) {
    document.getElementById('input').value = pendingExtract;
    document.getElementById('output').value = '';
    showMsg('抽出しました — 変換ボタンを押してください');
  }
  closePreview();
});

document.getElementById('previewCancel').addEventListener('click', closePreview);
document.getElementById('previewOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closePreview();
});

function closePreview() {
  document.getElementById('previewOverlay').classList.remove('active');
  pendingExtract = null;
}

function showMsg(text) {
  const el = document.getElementById('msg');
  el.textContent = text;
  setTimeout(() => el.textContent = '', 4000);
}
</script>
</body>
</html>
